name: Auto Update zengin_code gem

on:
  schedule:
    # 毎週月曜日午前9時（JST）に実行
    - cron: '0 0 * * 1'
  workflow_dispatch: # 手動実行も可能

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.5'
        bundler-cache: true

    - name: Get current zengin_code version
      id: current-version
      run: |
        CURRENT_VERSION=$(bundle list | grep "zengin_code" | sed -n 's/.*zengin_code (\(.*\))/\1/p')
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current zengin_code version: $CURRENT_VERSION"

    - name: Get latest zengin_code version
      id: latest-version
      run: |
        LATEST_VERSION=$(curl -s https://rubygems.org/api/v1/gems/zengin_code.json | jq -r '.version')
        echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "Latest zengin_code version: $LATEST_VERSION"

    - name: Check if update is needed
      id: check-update
      run: |
        if [ "${{ steps.current-version.outputs.current }}" != "${{ steps.latest-version.outputs.latest }}" ]; then
          echo "update_needed=true" >> $GITHUB_OUTPUT
          echo "Update needed: ${{ steps.current-version.outputs.current }} -> ${{ steps.latest-version.outputs.latest }}"
        else
          echo "update_needed=false" >> $GITHUB_OUTPUT
          echo "No update needed"
        fi

    - name: Create update branch and PR
      if: steps.check-update.outputs.update_needed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        LATEST_VERSION: ${{ steps.latest-version.outputs.latest }}
        CURRENT_VERSION: ${{ steps.current-version.outputs.current }}
      run: |
        # Git設定
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # 既存ブランチを削除（存在する場合）
        BRANCH_NAME="update-zengin-code-to-${LATEST_VERSION}"
        git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

        # ブランチ作成
        git checkout -b "$BRANCH_NAME"

        # Gemfileを更新
        sed -i 's/gem "zengin_code",.*/gem "zengin_code", "~> '"${LATEST_VERSION}"'", "<= '"${LATEST_VERSION}"'"/' Gemfile

        # frozen modeを無効化してbundle update実行
        bundle config set frozen false
        bundle update zengin_code

        # コミット
        git add Gemfile Gemfile.lock
        git commit -m "Update zengin_code gem from ${CURRENT_VERSION} to ${LATEST_VERSION}"

        # ブランチをプッシュ
        git push origin "$BRANCH_NAME"

        # PR作成
        gh pr create \
          --title "Update zengin_code gem to ${LATEST_VERSION}" \
          --label "Activate CI" \
          --reviewer "yuuki-satou-0316" \
          --body "$(cat <<EOF
        @Rakushifu/tp-developers
        @yuuki-satou-0316

        ## Deloy Info
        - Update zengin_code gem from ${CURRENT_VERSION} to ${LATEST_VERSION}
        - https://github.com/zengin-code/zengin-rb/tags

        ## Affected Users
        ※いずれか1つチェックすること
        - [ ] 一般ユーザーへの外部仕様面での変更あり
        - [ ] システム管理者のみ外部仕様面での変更あり
        - [ ] 外部仕様面での変更なし

        🤖 Auto-generated by GitHub Actions
        EOF
        )" \
          --base main \
          --head "$BRANCH_NAME"
