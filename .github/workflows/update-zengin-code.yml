name: Auto Update zengin_code gem

on:
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.5'
        bundler-cache: true

    - name: Get current zengin_code version
      id: current-version
      run: |
        CURRENT_VERSION=$(bundle list | grep "zengin_code" | sed -n 's/.*zengin_code (\(.*\))/\1/p')
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current zengin_code version: $CURRENT_VERSION"

    - name: Get latest zengin_code version
      id: latest-version
      run: |
        LATEST_VERSION=$(curl -s https://rubygems.org/api/v1/gems/zengin_code.json | jq -r '.version')
        echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "Latest zengin_code version: $LATEST_VERSION"

    - name: Check if update is needed
      id: check-update
      run: |
        if [ "${{ steps.current-version.outputs.current }}" != "${{ steps.latest-version.outputs.latest }}" ]; then
          echo "update_needed=true" >> $GITHUB_OUTPUT
          echo "Update needed: ${{ steps.current-version.outputs.current }} -> ${{ steps.latest-version.outputs.latest }}"
        else
          echo "update_needed=false" >> $GITHUB_OUTPUT
          echo "No update needed"
        fi

    - name: Create update branch and PR
      if: steps.check-update.outputs.update_needed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        LATEST_VERSION: ${{ steps.latest-version.outputs.latest }}
        CURRENT_VERSION: ${{ steps.current-version.outputs.current }}
      run: |
        # Gitè¨­å®š
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        BRANCH_NAME="update-zengin-code-to-${LATEST_VERSION}"
        git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

        # ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
        git checkout -b "$BRANCH_NAME"

        # Gemfileã‚’æ›´æ–°
        sed -i 's/gem "zengin_code",.*/gem "zengin_code", "~> '"${LATEST_VERSION}"'", "<= '"${LATEST_VERSION}"'"/' Gemfile

        # frozen modeã‚’ç„¡åŠ¹åŒ–ã—ã¦bundle updateå®Ÿè¡Œ
        bundle config set frozen false
        bundle update zengin_code

        # ã‚³ãƒŸãƒƒãƒˆ
        git add Gemfile Gemfile.lock
        git commit -m "Update zengin_code gem from ${CURRENT_VERSION} to ${LATEST_VERSION}"

        # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
        git push origin "$BRANCH_NAME"

        # PRä½œæˆ
        gh pr create \
          --title "Update zengin_code gem to ${LATEST_VERSION}" \
          --label "Activate CI" \
          --reviewer "yuuki-satou-0316" \
          --body "$(cat <<EOF
        @Rakushifu/tp-developers
        @yuuki-satou-0316

        ## Deloy Info
        - Update zengin_code gem from ${CURRENT_VERSION} to ${LATEST_VERSION}
        - https://github.com/zengin-code/zengin-rb/tags

        ## Affected Users
        â€»ã„ãšã‚Œã‹1ã¤ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨
        - [ ] ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¤–éƒ¨ä»•æ§˜é¢ã§ã®å¤‰æ›´ã‚ã‚Š
        - [ ] ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ã¿å¤–éƒ¨ä»•æ§˜é¢ã§ã®å¤‰æ›´ã‚ã‚Š
        - [ ] å¤–éƒ¨ä»•æ§˜é¢ã§ã®å¤‰æ›´ãªã—

        ðŸ¤– Auto-generated by GitHub Actions
        EOF
        )" \
          --base main \
          --head "$BRANCH_NAME"
