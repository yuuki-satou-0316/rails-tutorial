name: Auto Update zengin_code gem

on:
  schedule:
    # æ¯Žæ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.5'
        bundler-cache: true

    - name: Get current zengin_code version
      id: current-version
      run: |
        CURRENT_VERSION=$(bundle list | grep "zengin_code" | sed -n 's/.*zengin_code (\(.*\))/\1/p')
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current zengin_code version: $CURRENT_VERSION"

    - name: Get latest zengin_code version
      id: latest-version
      run: |
        LATEST_VERSION=$(curl -s https://rubygems.org/api/v1/gems/zengin_code.json | jq -r '.version')
        echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "Latest zengin_code version: $LATEST_VERSION"

    - name: Check if update is needed
      id: check-update
      run: |
        if [ "${{ steps.current-version.outputs.current }}" != "${{ steps.latest-version.outputs.latest }}" ]; then
          echo "update_needed=true" >> $GITHUB_OUTPUT
          echo "Update needed: ${{ steps.current-version.outputs.current }} -> ${{ steps.latest-version.outputs.latest }}"
        else
          echo "update_needed=false" >> $GITHUB_OUTPUT
          echo "No update needed"
        fi

    - name: Create update branch and PR
      if: steps.check-update.outputs.update_needed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        LATEST_VERSION: ${{ steps.latest-version.outputs.latest }}
        CURRENT_VERSION: ${{ steps.current-version.outputs.current }}
      run: |
        # Gitè¨­å®š
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
        BRANCH_NAME="update-zengin-code-to-${LATEST_VERSION}"
        git checkout -b "$BRANCH_NAME"

        # Gemfileã‚’æ›´æ–°
        sed -i 's/gem "zengin_code",.*/gem "zengin_code", "~> '"${LATEST_VERSION}"'", "<= '"${LATEST_VERSION}"'"/' Gemfile

        # frozen modeã‚’ç„¡åŠ¹åŒ–ã—ã¦bundle updateå®Ÿè¡Œ
        bundle config set frozen false
        bundle update zengin_code

        # ã‚³ãƒŸãƒƒãƒˆ
        git add Gemfile Gemfile.lock
        git commit -m "Update zengin_code gem from ${CURRENT_VERSION} to ${LATEST_VERSION}"

        # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
        git push origin "$BRANCH_NAME"

        # PRä½œæˆ
        gh pr create \
          --title "Update zengin_code gem to ${LATEST_VERSION}" \
          --body "$(cat <<EOF
        ## Summary
        - Update zengin_code gem from ${CURRENT_VERSION} to ${LATEST_VERSION}

        ## Changes
        - Updated Gemfile to specify zengin_code ${LATEST_VERSION}
        - Updated Gemfile.lock with bundle update zengin_code

        ## Test Plan
        - [ ] Verify application starts successfully
        - [ ] Run test suite to ensure no breaking changes
        - [ ] Check that zengin_code functionality works as expected

        ðŸ¤– Auto-generated by GitHub Actions
        EOF
        )" \
          --base main \
          --head "$BRANCH_NAME"
